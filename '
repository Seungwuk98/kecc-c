#ifndef KECC_ASM_H
#define KECC_ASM_H

#include "kecc/utils/List.h"
#include "llvm/ADT/SmallVector.h"
#include "llvm/ADT/StringRef.h"

namespace kecc::as {

template <typename Declaration> class Section;
class Block;
class Variable;
class Directive;
class Function;
class Instruction;

class Asm {
public:
private:
  llvm::SmallVector<Section<Function> *> functions;
  llvm::SmallVector<Section<Variable> *> variables;
};

template <typename Declaration> class Section {
public:
private:
  llvm::SmallVector<Directive *> directives;
  Declaration *declaration;
};

class Function {
public:
private:
  llvm::SmallVector<Block *> blocks;
};

class Variable {
public:
private:
  llvm::StringRef label;
  llvm::SmallVector<Directive *> directives;
};

class Block : public utils::ListObject<Block, Instruction *> {
public:
  using Node = utils::ListObject<Block, Instruction *>::Node;

private:
  llvm::StringRef label;
};

class Directive {
public:
  enum class Kind {
    Align,
    Globl,
    Section,
    Type,
    Byte,
    Half,
    Word,
    Quad,
    Zero,
  };
  virtual ~Directive() = default;
  virtual std::string toString() const = 0;

  Kind getKind() const { return kind; }

protected:
  Directive(Kind kind) : kind(kind) {}

private:
  Kind kind;
};

class AlignDirective : public Directive {
public:
  AlignDirective(std::size_t alignment)
      : Directive(Kind::Align), alignment(alignment) {}

  std::string toString() const override;
  std::size_t getAlignment() const { return alignment; }

private:
  std::size_t alignment;
};

class GloblDirective : public Directive {
public:
  GloblDirective(llvm::StringRef label)
      : Directive(Kind::Globl), label(label) {}

  std::string toString() const override;
  llvm::StringRef getLabel() const { return label; }

private:
  std::string label;
};

class SectionDirective : public Directive {
public:
  enum SectionType {
    Text,
    Data,
    Rodata,
    Bss,
  };

  SectionDirective(SectionType sectionType)
      : Directive(Kind::Section), sectionType(sectionType) {}

  std::string toString() const override;
  SectionType getSectionType() const { return sectionType; }

private:
  SectionType sectionType;
};

class TypeDirective : public Directive {
public:
  enum class Kind {
    Function,
    Object,
  };

  TypeDirective(llvm::StringRef label, Kind kind)
      : Directive(Directive::Kind::Type), label(label), kind(kind) {}

  std::string toString() const override;
  llvm::StringRef getLabel() const { return label; }
  Kind getKind() const { return kind; }

private:
  std::string label;
  Kind kind;
};

class ByteDirective : public Directive {
public:
  ByteDirective(std::int8_t value) : Directive(Kind::Byte), value(value) {}

  std::string toString() const override;
  std::uint8_t getValue() const { return value; }

private:
  std::uint8_t value;
};

class HalfDirective : public Directive {
public:
  HalfDirective(std::int16_t value) : Directive(Kind::Half), value(value) {}

  std::string toString() const override;
  std::uint16_t getValue() const { return value; }

private:
  std::uint16_t value;
};

class WordDirective : public Directive {
public:
  WordDirective(std::int32_t value) : Directive(Kind::Word), value(value) {}
  std::string toString() const override;
  std::uint32_t getValue() const { return value; }

private:
  std::uint32_t value;
};

} // namespace kecc::as

#endif // KECC_ASM_H
